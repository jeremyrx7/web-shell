name: ðŸ”„ Update Widget Dependencies

# This workflow is triggered by a repository dispatch event from the widget-library
# when new widget packages are published. It automatically updates the dependencies
# and creates a pull request with the changes.

on:
  repository_dispatch:
    types: [widget-packages-updated]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to update (JSON format)'
        required: true
        default: '[]'
      force_update:
        description: 'Force update even if no changes detected'
        type: boolean
        default: false

env:
  NODE_VERSION: "20"
  NPM_REGISTRY: "https://npm.pkg.github.com"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: ðŸ“¦ Update Widget Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Configure NPM for GitHub Packages
        run: |
          echo "@jeremyrx7:registry=${{ env.NPM_REGISTRY }}" >> ~/.npmrc
          echo "${{ env.NPM_REGISTRY }}/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Extract package information
        id: extract-packages
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            PACKAGES='${{ github.event.client_payload.published_packages }}'
            NEW_VERSION='${{ github.event.client_payload.new_version }}'
            SOURCE_REPO='${{ github.event.client_payload.source_repo }}'
            WORKFLOW_RUN_URL='${{ github.event.client_payload.workflow_run_url }}'
          else
            PACKAGES='${{ github.event.inputs.packages }}'
            NEW_VERSION="manual-update"
            SOURCE_REPO="manual"
            WORKFLOW_RUN_URL=""
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "source-repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "workflow-run-url=$WORKFLOW_RUN_URL" >> $GITHUB_OUTPUT

          echo "Packages to update: $PACKAGES"
          echo "New version: $NEW_VERSION"

      - name: Update package.json dependencies
        id: update-deps
        run: |
          PACKAGES='${{ steps.extract-packages.outputs.packages }}'
          UPDATED_PACKAGES=""
          HAS_CHANGES=false

          if [ "$PACKAGES" != "[]" ] && [ "$PACKAGES" != "" ]; then
            echo "Updating packages..."

            # Parse packages and update each one
            echo "$PACKAGES" | jq -r '.[] | "\(.name)@\(.version)"' | while read -r package; do
              if [ -n "$package" ]; then
                echo "Updating $package..."
                npm install "$package" --save

                if [ $? -eq 0 ]; then
                  UPDATED_PACKAGES="$UPDATED_PACKAGES $package"
                  HAS_CHANGES=true
                  echo "âœ… Successfully updated $package"
                else
                  echo "âŒ Failed to update $package"
                fi
              fi
            done

            # Check if package.json was actually modified
            if git diff --quiet package.json package-lock.json; then
              echo "No changes detected in package.json or package-lock.json"
              HAS_CHANGES=false
            else
              echo "Changes detected in package files"
              HAS_CHANGES=true
            fi
          else
            echo "No packages to update"
            HAS_CHANGES=false
          fi

          echo "has-changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "updated-packages=$UPDATED_PACKAGES" >> $GITHUB_OUTPUT

      - name: Create pull request
        if: steps.update-deps.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Update widget dependencies to ${{ steps.extract-packages.outputs.new-version }}

            Auto-generated by widget-library publish workflow
          title: "ðŸ”„ Update widget dependencies to ${{ steps.extract-packages.outputs.new-version }}"
          body: |
            ## ðŸ”„ Widget Dependencies Update

            This PR was automatically created in response to new widget package publications.

            ### ðŸ“¦ Updated Packages
            ${{ steps.extract-packages.outputs.packages && fromJson(steps.extract-packages.outputs.packages) && join(fromJson(steps.extract-packages.outputs.packages).*.name, ', ') || 'None specified' }}

            ### ðŸ”— Source Information
            - **Source Repository:** ${{ steps.extract-packages.outputs.source-repo }}
            - **Widget Library Version:** ${{ steps.extract-packages.outputs.new-version }}
            ${{ steps.extract-packages.outputs.workflow-run-url && format('- **Workflow Run:** {0}', steps.extract-packages.outputs.workflow-run-url) || '' }}

            ### ðŸ“‹ Changes Made
            - Updated widget package dependencies in `package.json`
            - Updated `package-lock.json` with new dependency resolution

            ### ðŸ§ª Testing
            Please test the following before merging:
            - [ ] Run `npm install` to verify dependencies resolve correctly
            - [ ] Run `npm run build` to ensure the application builds successfully
            - [ ] Run `npm run dev` to verify the application starts correctly
            - [ ] Test widget functionality if applicable

            ### ðŸ¤– Auto-merge
            This PR can be safely auto-merged if all checks pass and no breaking changes are expected.

            ---

            _This PR was automatically generated by the widget-library publish workflow._
          branch: update-widget-dependencies-${{ steps.extract-packages.outputs.new-version }}
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            dependencies
            widget-library
            automated

      - name: Create workflow summary
        run: |
          echo "## ðŸ”„ Widget Dependencies Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update-deps.outputs.has-changes }}" = "true" ]; then
            echo "âœ… **Status:** Dependencies updated and PR created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Updated Packages:**" >> $GITHUB_STEP_SUMMARY
            echo '${{ steps.extract-packages.outputs.packages }}' | jq -r '.[] | "- `\(.name)@\(.version)`"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions Taken:**" >> $GITHUB_STEP_SUMMARY
            echo "- Updated package.json with new widget package versions" >> $GITHUB_STEP_SUMMARY
            echo "- Updated package-lock.json with new dependency resolution" >> $GITHUB_STEP_SUMMARY
            echo "- Created pull request for review and merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status:** No updates needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Either no packages were provided for update, or the current versions are already up to date." >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.extract-packages.outputs.workflow-run-url }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Source Workflow:** ${{ steps.extract-packages.outputs.workflow-run-url }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on failure
        if: failure()
        run: |
          echo "## âŒ Widget Dependencies Update Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The automatic dependency update process failed. This could be due to:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues or npm registry problems" >> $GITHUB_STEP_SUMMARY
          echo "- Authentication issues with GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "- Package version conflicts or dependency resolution errors" >> $GITHUB_STEP_SUMMARY
          echo "- Missing or invalid package information in the trigger event" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manual Action Required:** Please review the workflow logs and update dependencies manually if needed." >> $GITHUB_STEP_SUMMARY
