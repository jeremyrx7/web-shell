name: ðŸ”„ Update Widget Dependencies

# This workflow is triggered by a repository dispatch event from the widget-library
# when new widget packages are published. It automatically updates the dependencies
# and creates a pull request with the changes.

on:
  repository_dispatch:
    types: [widget-packages-updated]
  workflow_dispatch:
    inputs:
      packages:
        description: "Packages to update (JSON format)"
        required: true
        default: "[]"
      force_update:
        description: "Force update even if no changes detected"
        type: boolean
        default: false

env:
  NODE_VERSION: "20"
  NPM_REGISTRY: "https://npm.pkg.github.com"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: ðŸ“¦ Update Widget Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Configure NPM for GitHub Packages
        run: |
          echo "@jeremyrx7:registry=${{ env.NPM_REGISTRY }}" >> ~/.npmrc
          echo "${{ env.NPM_REGISTRY }}/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Extract package information
        id: extract-packages
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Get the entire client payload as JSON
            CLIENT_PAYLOAD='${{ toJSON(github.event.client_payload) }}'

            # Extract individual fields using jq
            PACKAGES=$(echo "$CLIENT_PAYLOAD" | jq -c '.published_packages // []')
            NEW_VERSION=$(echo "$CLIENT_PAYLOAD" | jq -r '.new_version // "unknown"')
            SOURCE_REPO=$(echo "$CLIENT_PAYLOAD" | jq -r '.source_repo // "unknown"')
            WORKFLOW_RUN_URL=$(echo "$CLIENT_PAYLOAD" | jq -r '.workflow_run_url // ""')
          else
            PACKAGES='${{ github.event.inputs.packages }}'
            NEW_VERSION="manual-update"
            SOURCE_REPO="manual"
            WORKFLOW_RUN_URL=""
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "source-repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "workflow-run-url=$WORKFLOW_RUN_URL" >> $GITHUB_OUTPUT

          echo "=== DEBUG: Package Information ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Packages to update: $PACKAGES"
          echo "New version: $NEW_VERSION"
          echo "Source repo: $SOURCE_REPO"
          echo "Workflow URL: $WORKFLOW_RUN_URL"
          echo "Raw client_payload: ${{ toJSON(github.event.client_payload) }}"
          echo "=================================="

      - name: Update package.json dependencies
        id: update-deps
        env:
          PACKAGES_TO_UPDATE: ${{ steps.extract-packages.outputs.packages }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          node scripts/update-widget-dependencies.js

      - name: Create pull request
        if: steps.update-deps.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Update widget dependencies to ${{ steps.extract-packages.outputs.new-version }}

            Auto-generated by widget-library publish workflow
          title: "ðŸ”„ Update widget dependencies to ${{ steps.extract-packages.outputs.new-version }}"
          body: |
            ## ðŸ”„ Widget Dependencies Update

            This PR was automatically created in response to new widget package publications.

            ### ðŸ“¦ Updated Packages
            ${{ steps.update-deps.outputs.summary && fromJson(steps.update-deps.outputs.summary).updatedPackages && join(fromJson(steps.update-deps.outputs.summary).updatedPackages.*.name, ', ') || 'None specified' }}

            ### ðŸ”— Source Information
            - **Source Repository:** ${{ steps.extract-packages.outputs.source-repo }}
            - **Widget Library Version:** ${{ steps.extract-packages.outputs.new-version }}
            ${{ steps.extract-packages.outputs.workflow-run-url && format('- **Workflow Run:** {0}', steps.extract-packages.outputs.workflow-run-url) || '' }}

            ### ðŸ“‹ Changes Made
            ${{ steps.update-deps.outputs.summary && fromJson(steps.update-deps.outputs.summary).updatedPackages && join(fromJson(steps.update-deps.outputs.summary).updatedPackages.*.change, '
            - ') || 'No changes made' }}

            - Updated widget package dependencies in `package.json`
            - Updated `package-lock.json` with new dependency resolution

            ### ðŸ§ª Testing
            Please test the following before merging:
            - [ ] Run `npm install` to verify dependencies resolve correctly
            - [ ] Run `npm run build` to ensure the application builds successfully
            - [ ] Run `npm run dev` to verify the application starts correctly
            - [ ] Test widget functionality if applicable

            ### ðŸ¤– Auto-merge
            This PR can be safely auto-merged if all checks pass and no breaking changes are expected.

            ---

            _This PR was automatically generated by the widget-library publish workflow._
          branch: update-widget-dependencies-${{ steps.extract-packages.outputs.new-version }}
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            dependencies
            widget-library
            automated
